{% extends 'base.html' %}
{% block title %}Edit Profile{% endblock %}

{% block content %}
<h2>Edit Profile</h2>

<div class="card p-4 light-mode-card" style="max-width:650px;">

  <form method="post" enctype="multipart/form-data">

    <div class="text-center mb-3">
      <img
        src="{{ user.profile_image and url_for('static', filename='uploads/' ~ user.profile_image) or url_for('static', filename='img/placeholder.jpg') }}"
        class="rounded-circle" width="120" height="120" style="object-fit:cover;">
    </div>

    <div class="mb-3">
      <label class="form-label">Profile Picture</label>
      <input type="file" name="profile_image" class="form-control">
    </div>

    <div class="mb-3">
      <label class="form-label">Full Name</label>
      <input class="form-control" name="full_name" value="{{ user.full_name or '' }}" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Phone</label>
      <input class="form-control" name="phone" value="{{ user.phone or '' }}" required>
    </div>

    <div class="mb-3">
      <label class="form-label d-flex align-items-center">
        Email
        {% if user.email_verified %}
        <span class="email-verify-badge badge-verified"><i class="bi bi-patch-check-fill"></i> Verified</span>
        {% else %}
        <span class="email-verify-badge badge-unverified"><i class="bi bi-exclamation-circle"></i> Unverified </span>

        {% endif %}
      </label>
      <div class="input-group">
        <input type="email" class="form-control" name="email" id="email-field" value="{{ user.email or '' }}" required>
        {% if not user.email_verified %}
        <button class="btn btn-outline-primary" type="button" id="init-verify-btn" onclick="toggleVerification()">
          Verify
        </button>
        {% endif %}
      </div>

      <div class="verification-group mt-3 fade-in-up" id="verification-section" style="display: none;">
        <div class="d-flex align-items-start gap-3">
          <div class="p-2 rounded-circle bg-primary bg-opacity-10 text-primary">
            <i class="bi bi-shield-lock-fill fs-4"></i>
          </div>
          <div class="flex-grow-1">
            <h6 class="fw-bold mb-1">Verify Email Address</h6>
            <p class="small text-muted mb-3">We will send a code to the email above.</p>

            <!-- Step 1: Request Code -->
            <div id="otp-request-area">
              <button type="button" class="btn btn-sm btn-primary px-4 rounded-pill" id="send-code-btn"
                onclick="sendVerificationCode()">
                <i class="bi bi-send-fill me-2"></i>Send Verification Code
              </button>
            </div>

            <!-- Step 2: Verify Code -->
            <div id="otp-verify-area" style="display: none;" class="fade-in-up">
              <div class="verification-input-wrap">
                <input type="text" id="verification-code" class="form-control otp-input" placeholder="XXXXXX"
                  maxlength="4">
                <button type="button" class="btn btn-success px-4 rounded-pill fw-bold" onclick="verifyCode()">
                  Verify <i class="bi bi-check-lg ms-1"></i>
                </button>
              </div>
              <div class="d-flex align-items-center mt-2">
                <span class="spinner-border spinner-border-sm text-primary me-2 d-none" id="verify-spinner"></span>
                <small class="text-primary fw-bold" id="code-sent-msg" style="display:none;"><i
                    class="bi bi-envelope-check me-1"></i> Code sent!</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function toggleVerification() {
        const sec = document.getElementById('verification-section');
        if (sec.style.display === 'none') {
          sec.style.display = 'block';
        } else {
          sec.style.display = 'none';
        }
      }

      async function sendVerificationCode() {
        const btn = document.getElementById('send-code-btn');
        const reqArea = document.getElementById('otp-request-area');
        const verArea = document.getElementById('otp-verify-area');
        const emailInput = document.getElementById('email-field').value;

        if (!emailInput || !emailInput.includes('@')) {
          showNotification('Please enter a valid email address first.', 'warning');
          return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Sending...';

        try {
          const res = await fetch('/api/send-verification-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: emailInput })
          });
          const data = await res.json();

          if (data.success) {
            showNotification(data.message, 'success');
            reqArea.style.display = 'none';
            verArea.style.display = 'block';
            document.getElementById('code-sent-msg').style.display = 'block';
          } else {
            showNotification(data.message, 'warning');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-send-fill me-1"></i> Send Verification Code';
          }
        } catch (err) {
          showNotification('Error sending code.', 'warning');
          btn.disabled = false;
          btn.innerHTML = '<i class="bi bi-send-fill me-1"></i> Send Verification Code';
        }
      }

      async function verifyCode() {
        const code = document.getElementById('verification-code').value;
        const emailInput = document.getElementById('email-field').value;
        const spinner = document.getElementById('verify-spinner');

        if (!code || code.length !== 4) {
          showNotification('Please enter the 4-digit code.', 'warning');
          return;
        }

        if (spinner) spinner.classList.remove('d-none');

        try {
          const res = await fetch('/api/verify-email-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code, email: emailInput })
          });
          const data = await res.json();

          if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
          } else {
            showNotification(data.message, 'warning');
            if (spinner) spinner.classList.add('d-none');
          }
        } catch (err) {
          showNotification('Verification error.', 'warning');
          if (spinner) spinner.classList.add('d-none');
        }
      }
    </script>

    <h5>Address</h5>

    <div class="mb-3">
      <label class="form-label">District</label>
      <input class="form-control" name="district" value="{{ user.address_district or '' }}">
    </div>

    <div class="mb-3">
      <label class="form-label">City</label>
      <input class="form-control" name="city" value="{{ user.address_city or '' }}">
    </div>

    <div class="mb-3">
      <label class="form-label">Street Address</label>
      <input class="form-control" name="street" value="{{ user.address_street or '' }}">
    </div>

    <button class="btn btn-success mt-2">Save Changes</button>
    <a href="{{ url_for('profile') }}" class="btn btn-link">Cancel</a>
  </form>

</div>

{% endblock %}