{% extends 'admin/admin_base.html' %}

{% block title %}Manage Orders - Admin{% endblock %}

{% block admin_title %}Order Management{% endblock %}


{% block head %}
<meta http-equiv="refresh" content="60">
{% endblock %}


{% block content %}
<div class="glass-card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="mb-0 text-white"><i class="bi bi-cart-check me-2 text-primary"></i>All Customer Orders</h5>
    </div>
    <div class="table-responsive">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>SL#</th>
                    <th>Order #</th>
                    <th>Customer</th>
                    <th>Items</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for o in orders %}
                <tr>
                    <td><span class="text-white opacity-75">{{ loop.index }}</span></td>
                    <td>
                        <a href="javascript:void(0);" onclick="openOrderModal({{ o.id }})"
                            class="text-info text-decoration-none fw-bold">
                            #{{ o.unique_order_number or o.id }}
                        </a>
                    </td>
                    <td>
                        {% if o.user %}
                        <a class="text-info text-decoration-none fw-bold" href="javascript:void(0);"
                            onclick="openUserModal('{{ o.user.username }}')">@{{ o.user.username }}</a>
                        {% else %}
                        <span class="text-white opacity-75">Anonymous</span>
                        {% endif %}
                    </td>
                    <td>
                        <small class="text-stylish">
                            {% for item in o.items_parsed %}
                            {{ item.name }} x{{ item.qty }}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </small>
                    </td>
                    <td><span class="text-white fw-bold">${{ '%.2f'|format(o.total) }}</span></td>
                    <td>
                        <span class="badge-admin 
                            {% if o.status == 'Confirmed' %}badge-admin-success
                            {% elif o.status == 'Paid' %}badge-admin-info
                            {% else %}badge-admin-warning{% endif %}">
                            {{ o.status }}
                        </span>
                    </td>
                    <td><small class="text-stylish">{{ o.created_at.strftime('%Y-%m-%d %H:%M') }}</small></td>
                    <td>
                        <div class="btn-group">
                            {% if o.status != 'Confirmed' %}
                            <a class="btn btn-sm btn-success"
                                href="{{ url_for('admin_confirm_order', order_id=o.id, sl=loop.index) }}">
                                <i class="bi bi-check-circle"></i> Confirm
                            </a>
                            {% endif %}
                            <a class="btn btn-sm btn-outline-danger"
                                href="{{ url_for('admin_delete_order', order_id=o.id, sl=loop.index) }}"
                                onclick="return confirm('Permanently delete this order record?')">
                                <i class="bi bi-trash"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="text-center py-4 text-stylish">No orders found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal logic is handled in index.html, so for consistency we'll add the modal scripts if needed or move them to base. 
     Actually, let's just make sure searching works here too. -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-white"><i class="bi bi-person-gear me-2"></i>User Profile</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body border-secondary" id="userModalBody">
                <!-- Placeholder - populated via AJAX -->
                <div class="text-center p-4">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- ORDER DETAIL MODAL -->
<div class="modal fade" id="orderModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark border-secondary text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-white"><i class="bi bi-receipt me-2"></i>Order Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body border-secondary" id="orderModalBody">
                <div class="text-center p-4">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function openUserModal(username) {
        const modal = new bootstrap.Modal(document.getElementById('userModal'));
        const body = document.getElementById('userModalBody');
        body.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"></div></div>';
        modal.show();

        fetch(`/admin/user/${username}`)
            .then(res => { if (!res.ok) throw new Error('User not found'); return res.json(); })
            .then(data => {
                body.innerHTML = `
            <div class="text-center mb-4">
              <img src="${data.profile_image ? '/static/uploads/' + data.profile_image : '/static/img/placeholder.jpg'}" class="rounded-circle border border-secondary p-1" width="100" height="100" style="object-fit:cover;">
            </div>
            <div class="row g-3">
              <div class="col-12"><label class="text-muted small">Username</label><p class="text-white fw-bold mb-0">${data.username}</p></div>
              <div class="col-md-6"><label class="text-muted small">Email</label><p class="text-white mb-0">${data.email}</p></div>
              <div class="col-md-6"><label class="text-muted small">Full Name</label><p class="text-white mb-0">${data.full_name}</p></div>
              <div class="col-md-6"><label class="text-muted small">Phone</label><p class="text-white mb-0">${data.phone || 'N/A'}</p></div>
              <div class="col-md-6"><label class="text-muted small">City</label><p class="text-white mb-0">${data.address_city || 'N/A'}</p></div>
              <div class="col-12"><label class="text-muted small">Street</label><p class="text-white mb-0">${data.address_street || 'N/A'}</p></div>
            </div>
        `;
            })
            .catch(err => {
                body.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
            });
    }

    function openOrderModal(orderId) {
        const modal = new bootstrap.Modal(document.getElementById('orderModal'));
        const body = document.getElementById('orderModalBody');
        body.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"></div></div>';
        modal.show();

        fetch(`/admin/order/${orderId}`)
            .then(res => { if (!res.ok) throw new Error('Order not found'); return res.json(); })
            .then(data => {
                let itemsHtml = data.items.map(item => `
                    <div class="d-flex justify-content-between border-bottom border-secondary py-2">
                        <span class="text-stylish">${item.name} x ${item.qty}</span>
                        <span class="text-white fw-bold">$${(item.price * item.qty).toFixed(2)}</span>
                    </div>
                `).join('');

                body.innerHTML = `
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="text-muted small d-block mb-1">Order Status</label>
                            <span class="badge bg-${data.status === 'Confirmed' ? 'success' : 'primary'} mb-3">${data.status}</span>
                            
                            <label class="text-muted small d-block mb-1">Customer Info</label>
                            <p class="text-white mb-0 fw-bold">${data.customer}</p>
                            <p class="text-stylish small mb-2">@${data.username}</p>
                            <p class="text-white mb-3"><i class="bi bi-telephone me-2"></i>${data.phone}</p>
                            
                            <label class="text-muted small d-block mb-1">Delivery Address</label>
                            <p class="text-white small mb-0">${data.address_street}</p>
                            <p class="text-white small mb-0">${data.address_city}, ${data.address_district}</p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small d-block mb-3">Order Items</label>
                            <div class="bg-black bg-opacity-25 rounded p-3 mb-3">
                                ${itemsHtml}
                                <div class="d-flex justify-content-between mt-3 pt-2 border-top border-white border-opacity-25">
                                    <span class="text-white fw-bold">Total</span>
                                    <span class="text-primary fw-bold fs-5">$${data.total.toFixed(2)}</span>
                                </div>
                            </div>
                            <small class="text-muted">Placed on ${data.created_at}</small>
                        </div>
                    </div>
                `;
            })
            .catch(err => {
                body.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
            });
    }
</script>
{% endblock %}